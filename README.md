# springboot-user-registration

## üìã Descripci√≥n general

Este proyecto es un sistema de registro de usuarios construido con Spring Boot. Proporciona APIs RESTful para el registro, autenticaci√≥n y gesti√≥n de usuarios.

## üìÇ Estructura del proyecto

- `controller/` - Controladores REST
- `service/` - L√≥gica de negocio
- `repository/` - Acceso a datos
- `model/` - Entidades JPA
- `dto/` - Objetos de transferencia de datos
- `exception/` - Excepciones personalizadas y manejadores
- `config/` - Clases de configuraci√≥n
- `mapper/` - Mapeo entre entidades y DTOs
- `security/` - Configuraci√≥n y utilidades de seguridad
- `utils/` - Utilidades generales


## üìä Diagrama de la soluci√≥n

El siguiente diagrama muestra la arquitectura de la aplicaci√≥n, incluyendo los componentes principales y sus interacciones:

![Diagrama de la arquitectura de la aplicaci√≥n](src/main/resources/architecture_diagram.png)

Este diagrama muestra:

1. **Capa de Presentaci√≥n**: Los controladores REST que reciben las peticiones HTTP y las dirigen a los servicios correspondientes.
2. **Capa de Seguridad**: El filtro de autenticaci√≥n JWT que valida los tokens en las peticiones.
3. **Capa de Servicio**: Los servicios que implementan la l√≥gica de negocio.
4. **Capa de Persistencia**: Los repositorios que interact√∫an con la base de datos.

## ‚ú® Funcionalidades
- Registro de usuarios con validaci√≥n
- Autenticaci√≥n de usuarios (login)
- Almacenamiento seguro de contrase√±as
- Endpoints para gesti√≥n de usuarios
- Manejo de excepciones
- Configuraci√≥n de expresiones regulares para validaci√≥n de contrase√±as

## üõ†Ô∏è Tecnolog√≠as utilizadas
- Java
- Spring Boot
- Spring Data JPA
- H2 (base de datos en memoria)
- Gradle
- Lombok
- SLF4J (Logger)
- Springdoc OpenAPI (para documentaci√≥n y anotaciones @Schema en los DTOs)
- MapStruct (para mapeo entre entidades y DTOs)

## üöÄ Primeros pasos

### üìã Prerrequisitos
- Java 17 o superior
- Gradle
- Docker y Docker Compose (opcional, para ejecuci√≥n con contenedores)

### ‚ñ∂Ô∏è Ejecuci√≥n de la aplicaci√≥n

#### M√©todo 1: Ejecuci√≥n local

1. Clone el repositorio:
   ```bash
   git clone <repository-url>
   cd springboot-user-registration
   ```
2. Compile y ejecute la aplicaci√≥n:
   ```bash
   ./gradlew bootRun
   ```
3. La aplicaci√≥n estar√° disponible en `http://localhost:8080` por defecto.

#### M√©todo 2: Ejecuci√≥n con Docker Compose

1. Aseg√∫rese de tener Docker y Docker Compose instalados en su sistema.
2. Clone el repositorio:
   ```bash
   git clone <repository-url>
   cd springboot-user-registration
   ```
3. Construya y ejecute la aplicaci√≥n:
   ```bash
   docker-compose up -d
   ```
4. La aplicaci√≥n estar√° disponible en `http://localhost:8080`.
5. Para ver los logs de la aplicaci√≥n en tiempo real:
   ```bash
   docker-compose logs -f
   ```
6. Para detener la aplicaci√≥n:
   ```bash
   docker-compose down
   ```

> **Nota**: Al utilizar Docker Compose, la base de datos H2 se persistir√° en un volumen Docker, lo que permite mantener los datos entre reinicios del contenedor.

### üìä Acceso a la consola H2
La consola H2 est√° habilitada y puede acceder a ella a trav√©s de:
- URL: `http://localhost:8080/h2-console`
- JDBC URL: `jdbc:h2:file:/app/data/testdb`
- Usuario: `sa`
- Contrase√±a: (dejar en blanco)

### üß™ Pruebas - Testing

Ejecute las pruebas con:
```bash
./gradlew test
```

## üîó Endpoints principales

- `POST /api/users/register` - Registrar un nuevo usuario
- `POST /api/auth/login` - Autenticar un usuario
- `GET /api/users` - Listar todos los usuarios (requiere autenticaci√≥n)
- `GET /api/configurations` - Listar todas las configuraciones activas (requiere autenticaci√≥n)
- `GET /api/configurations/{typeKey}` - Obtener una configuraci√≥n espec√≠fica por su tipo (requiere autenticaci√≥n)
- `PUT /api/configurations` - Actualizar una configuraci√≥n existente o crear una nueva (requiere autenticaci√≥n)
- `PUT /api/configurations/{typeKey}?value=nuevoValor` - Actualizar una configuraci√≥n por su tipo (requiere autenticaci√≥n)
- `PUT /api/configurations/{typeKey}/value` - Actualizar una configuraci√≥n por su tipo usando el cuerpo de la solicitud (requiere autenticaci√≥n)

## üìù Uso de la aplicaci√≥n

### üîÑ Consumo de endpoints con Postman

A continuaci√≥n se muestra c√≥mo consumir todos los endpoints de la API utilizando Postman:

#### üë§ Registro de usuarios

> **Nota sobre validaci√≥n de contrase√±as**: Actualmente, el sistema est√° configurado para validar contrase√±as con los siguientes criterios: m√≠nimo 8 caracteres, m√°ximo 30 caracteres, al menos 1 letra may√∫scula, 1 letra min√∫scula, 1 d√≠gito y 1 car√°cter especial (entre -.#$%&). Estos par√°metros pueden ser configurados a trav√©s de la API.

1. Abra Postman
2. Cree una nueva solicitud POST a `http://localhost:8080/api/users/register`
3. En la pesta√±a "Headers", agregue `Content-Type: application/json`
4. En la pesta√±a "Body", seleccione "raw" y "JSON", y agregue el siguiente contenido:
   ```json
   {
     "name": "Juan Rodriguez",
     "email": "juan@rodriguez.cl",
     "password": "Prueba.123$#-",
     "phones": [
       {
         "number": "1234567",
         "citycode": "1",
         "contrycode": "57"
       }
     ]
   }
   ```
5. Haga clic en "Send" para enviar la solicitud

#### üîê Autenticaci√≥n de usuarios

1. Abra Postman
2. Cree una nueva solicitud POST a `http://localhost:8080/api/auth/login`
3. En la pesta√±a "Headers", agregue `Content-Type: application/json`
4. En la pesta√±a "Body", seleccione "raw" y "JSON", y agregue el siguiente contenido:
   ```json
   {
     "email": "juan@rodriguez.cl",
     "password": "Prueba.123$#-"
   }
   ```
5. Haga clic en "Send" para enviar la solicitud
6. Este endpoint te devolver√° un token JWT que deber√°s usar para los endpoints protegidos.
7. Para acceder a endpoints protegidos, debes agregar el header `Authorization` con el valor `Bearer tu_token_jwt`.
   - Ejemplo: `Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

#### ‚öôÔ∏è Sistema de configuraci√≥n

El sistema permite personalizar los requisitos de contrase√±a a trav√©s de la API de configuraciones. Esto es especialmente √∫til para ajustar las pol√≠ticas de seguridad seg√∫n las necesidades espec√≠ficas de su organizaci√≥n.

> **Configuraciones disponibles para contrase√±as**:
> - `password.min.length`: Longitud m√≠nima de caracteres (valor predeterminado: 8)
> - `password.max.length`: Longitud m√°xima de caracteres (valor predeterminado: 30)
> - `password.min.uppercase`: Cantidad m√≠nima de letras may√∫sculas (valor predeterminado: 1)
> - `password.min.lowercase`: Cantidad m√≠nima de letras min√∫sculas (valor predeterminado: 1)
> - `password.min.digits`: Cantidad m√≠nima de d√≠gitos (valor predeterminado: 1)
> - `password.min.special`: Cantidad m√≠nima de caracteres especiales (valor predeterminado: 1)
> - `password.allowed.special`: Caracteres especiales permitidos (valor predeterminado: "-.#$%&")

##### ‚öôÔ∏è Obtener todas las configuraciones

1. Abra Postman
2. Cree una nueva solicitud GET a `http://localhost:8080/api/configurations`
3. En la pesta√±a "Headers", agregue `Authorization: Bearer YOUR_JWT_TOKEN` (reemplace YOUR_JWT_TOKEN con el token obtenido al autenticarse)
4. Haga clic en "Send" para enviar la solicitud

##### ‚öôÔ∏è Obtener una configuraci√≥n espec√≠fica

1. Abra Postman
2. Cree una nueva solicitud GET a `http://localhost:8080/api/configurations/password.min.length`
3. En la pesta√±a "Headers", agregue `Authorization: Bearer YOUR_JWT_TOKEN` (reemplace YOUR_JWT_TOKEN con el token obtenido al autenticarse)
4. Haga clic en "Send" para enviar la solicitud

##### ‚öôÔ∏è Actualizar una configuraci√≥n

1. Abra Postman
2. Cree una nueva solicitud PUT a `http://localhost:8080/api/configurations/password.min.length?value=10`
3. En la pesta√±a "Headers", agregue `Authorization: Bearer YOUR_JWT_TOKEN` (reemplace YOUR_JWT_TOKEN con el token obtenido al autenticarse)
4. Haga clic en "Send" para enviar la solicitud

##### ‚öôÔ∏è Actualizar una configuraci√≥n usando JSON

1. Abra Postman
2. Cree una nueva solicitud PUT a `http://localhost:8080/api/configurations`
3. En la pesta√±a "Headers", agregue `Content-Type: application/json`
4. En la pesta√±a "Headers", agregue `Authorization: Bearer YOUR_JWT_TOKEN` (reemplace YOUR_JWT_TOKEN con el token obtenido al autenticarse)
5. En la pesta√±a "Body", seleccione "raw" y "JSON", y agregue el siguiente contenido:
   ```json
   {
     "configurationTypeId": 1,
     "configValue": "10"
   }
   ```
6. Haga clic en "Send" para enviar la solicitud

> **Nota**: Al modificar las configuraciones de contrase√±a, los nuevos valores se aplicar√°n inmediatamente a todos los nuevos registros de usuarios. Esto permite ajustar din√°micamente las pol√≠ticas de seguridad sin necesidad de reiniciar la aplicaci√≥n.

##### ‚öôÔ∏è Actualizar una configuraci√≥n con caracteres especiales

Para actualizar configuraciones que requieren caracteres especiales (como `password.allowed.special`), se recomienda utilizar el endpoint alternativo que acepta el valor en el cuerpo de la solicitud:

1. Abra Postman
2. Cree una nueva solicitud PUT a `http://localhost:8080/api/configurations/password.allowed.special/value`
3. En la pesta√±a "Headers", agregue `Content-Type: application/json`
4. En la pesta√±a "Headers", agregue `Authorization: Bearer YOUR_JWT_TOKEN` (reemplace YOUR_JWT_TOKEN con el token obtenido al autenticarse)
5. En la pesta√±a "Body", seleccione "raw" y "JSON", y agregue el siguiente contenido:
   ```json
   {
     "value": "-.#$%&*@!+"
   }
   ```
6. Haga clic en "Send" para enviar la solicitud

> **Nota sobre caracteres especiales**: Cuando se utilizan caracteres especiales en URLs (como en el endpoint `?value=-.#$%&`), estos deben ser codificados correctamente. Por ejemplo, el car√°cter `#` debe codificarse como `%23`, `$` como `%24`, etc. Para evitar problemas de codificaci√≥n, se recomienda utilizar el endpoint alternativo que acepta el valor en el cuerpo de la solicitud.


## üìù Logging

Este proyecto utiliza SLF4J para el registro de mensajes informativos, advertencias y errores. Ejemplo de uso:

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class YourClass {
    private static final Logger logger = LoggerFactory.getLogger(YourClass.class);

    public void ejemploLogger() {
        logger.info("Mensaje informativo");
        logger.warn("Mensaje de advertencia");
        logger.error("Mensaje de error");
    }
}
```

## üìö Documentaci√≥n

A continuaci√≥n se presentan los enlaces a la documentaci√≥n disponible en el proyecto:

### üìò Documentaci√≥n de la API
- ‚úÖ **Swagger UI:** [`http://localhost:8080/swagger-ui/index.html`](http://localhost:8080/swagger-ui.html)

### üóÉÔ∏è Base de datos
- üìä **Documentaci√≥n de la base de datos:** [`docs/database/README.md`](docs/database/README.md)

### üîí Seguridad
- üîê **Documentaci√≥n de seguridad y JWT:** [`docs/security/README.md`](docs/security/README.md)

### üõ†Ô∏è Utilidades
- üìö **√çndice de utilidades:** [`docs/utils/README.md`](docs/utils/README.md)
- üìù **Tipos de configuraci√≥n de contrase√±as:** [`docs/utils/README-PasswordConfigurationType.md`](docs/utils/README-PasswordConfigurationType.md)
- üîç **Generaci√≥n de expresiones regulares:** [`docs/utils/README-PasswordRegexGenerator.md`](docs/utils/README-PasswordRegexGenerator.md)
- ‚úÖ **Validaci√≥n de contrase√±as:** [`docs/utils/README-PasswordValidator.md`](docs/utils/README-PasswordValidator.md)
- üîê **Cifrado de contrase√±as:** [`docs/utils/README-PasswordEncoderUtil.md`](docs/utils/README-PasswordEncoderUtil.md)

### üîÑ Mappers
- üîÑ **Documentaci√≥n de mappers:** [`docs/mappers/README.md`](docs/mappers/README.md)

### üõ°Ô∏è Excepciones
- üõ°Ô∏è **Documentaci√≥n de manejo de excepciones:** [`docs/exceptions/README.md`](docs/exceptions/README.md)

### üìù Ejercicio propuesto
- üìã **Descripci√≥n del ejercicio:** [`docs/exercise/integration_proposed_exercise.md`](docs/exercise/integration_proposed_exercise.md)

## üîÑ Cambios recientes
- üê≥ Se agreg√≥ soporte para Docker y Docker Compose, permitiendo ejecutar la aplicaci√≥n en contenedores.
- üìù Se actualiz√≥ la documentaci√≥n con instrucciones para ejecutar la aplicaci√≥n usando Docker Compose.
- üîß Se agreg√≥ un nuevo endpoint alternativo para actualizar configuraciones con caracteres especiales, permitiendo el env√≠o de valores a trav√©s del cuerpo de la solicitud en lugar de par√°metros URL.
- üîê Se agreg√≥ documentaci√≥n sobre las limitaciones actuales y mejoras futuras en seguridad, especificando que la generaci√≥n de refresh tokens no est√° dentro del alcance actual del proyecto pero deber√≠a implementarse en el futuro.
- üîß Se implement√≥ un controlador para la gesti√≥n de configuraciones del sistema, permitiendo editar los valores de validaci√≥n de contrase√±as.
- üîÑ Se crearon mappers para las entidades Configuration y ConfigurationType utilizando MapStruct.
- üõ°Ô∏è Se agreg√≥ documentaci√≥n detallada sobre el manejo de excepciones y posibles mejoras futuras.
- ‚úÖ Se implementaron utilidades para la validaci√≥n de contrase√±as basadas en configuraciones almacenadas en la base de datos.
- üìö Se agreg√≥ documentaci√≥n detallada sobre las utilidades de validaci√≥n de contrase√±as.
- üîÑ Se actualiz√≥ la documentaci√≥n para reflejar el uso de H2 como base de datos en memoria, eliminando referencias a PostgreSQL, Docker y .env para la base de datos.
- üìã Se actualiz√≥ la documentaci√≥n de la base de datos para incluir informaci√≥n detallada sobre el esquema de la base de datos y las entidades JPA implementadas.
- üîÑ Se agreg√≥ documentaci√≥n sobre el uso de MapStruct como biblioteca para el mapeo entre entidades y DTOs.
- üìù Se consolid√≥ la documentaci√≥n de Docker para evitar duplicidades y mejorar la claridad.

## üìÑ Licencia

Este proyecto est√° licenciado bajo MIT License.